def dockerWorkDir = file(project.layout.buildDirectory.dir('docker'))

task dockerCopyEntrypoint(type: Copy) {
    group 'docker'
    from project.file('docker-entrypoint.sh').absolutePath
    into dockerWorkDir
}

task dockerCopyJar(type: Copy) {
    group 'docker'
    if (project.hasProperty('bootJar')) {
        dependsOn assemble

        def dest = dockerWorkDir
        dest.mkdirs()

        from file(bootJar.archiveFile.get().asFile)
        into dest
    }
}

def imageTag = {
    if (project.hasProperty('imageTag')) {
        "$dockerNexusUrl/${dockerImageName}:${imageTag}"
    } else {
        "$dockerNexusUrl/${dockerImageName}:${version}"
    }
}

task dockerBuildImage(type: Exec) {
    group 'docker'
    if (project.hasProperty('bootJar')) {
        dependsOn dockerCopyJar
        dependsOn dockerCopyEntrypoint
        workingDir dockerWorkDir
        def dockerFile = project.layout.projectDirectory.file('Dockerfile').asFile.absolutePath
        commandLine 'docker', 'build', '-t', imageTag(), '-f', dockerFile, '--build-arg', "VERSION=${version}", '--build-arg', "JAR_NAME=${bootJar.archiveFileName.get()}", '.'
    }
}
